​<!DOCTYPE html>
<html>
<head>
    <link href="https://fonts.googleapis.com/css?family=Lato:900" rel="stylesheet">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link id="basestyle" rel="stylesheet" type="text/css" href="./style/style.css">
    <link id="style" rel="stylesheet" type="text/css" href="./style/style.css">
    </head>
<body>
<div id="theme">
    <div id="footer">
        <button id="defaultStyle" type="button" name ="defaultTheme" onclick="changeStyle('style/style.css')">Default</button>
        <button id="stylesheet1" type="button" name="darkTheme" onclick="changeStyle('style/theme1.css')">Dark</button>
        <button id="stylesheet2" type="button" name="colorTheme" onclick="changeStyle('style/theme2.css')">Color</button>
    </div>
<div id="container">
<div id="header">
<h1>ToDo Applikasjonen</h1>
</div>
<div id="content">
</div>
    <template id="addRequestTemplate">
        <form>
            <label for="description">Description:</label>
            <input type="text" id="description">
            <button id="submitRequest" type="button">Submit</button>
        </form>
    </template>

    <template id="authenticateUserUITemplate">
        <form>
            <label for="userName"></label><br/>
            <input type="text" id="userName" placeholder="Username"><br/>

            <label for="password"></label><br/>
            <input type="password" id="password" placeholder="Password"><br/>

            <label for="rememberMe">Remember Me:</label>
            <input type="checkbox" id="rememberMe"><br/>

            <button type="button" id="loginBt">Login</button>
            <button type="button" id="createUserBt">Create User</button>
        </form>
        <div id="errorView" class="card error" hidden>
            <div class="section">
                <h1>Error</h1>
            </div>
            <div class="section">
                <p id="msg"></p>
            </div>
        </div>
    </template>

    <template id="createUserUITemplate">
        <form id="createUserForm">
            <label for="userName"></label><br/>
            <input type="text" id="userName" placeholder="Username"><br/>

            <label for="email"></label><br/>
            <input type="email" id="email" placeholder="Email"><br/>

            <label for="password">Password:</label><br/>
            <input type="password" id="password" placeholder="Password"><br/>
            
            <button>Create</button>
        </form>

    </template>

    <template id="createTaskTemplate">
        <div id="divTaskForm">
        <form id="createTaskForm">
            <label for="task">Liste-Tittel</label> 
            <input type="text" id="tittel"><br>

            <label for="description">Liste-Beskrivelse</label> 
            <input type="text" id="innhold"><br>
            
            <button type="button" id="submitTask">Submit</button>
        </form>
        </div>
        
        <div id="divPostForm">
        <form id="createPostForm">
            <label for="task">Overskrift</label> 
            <input type="text" id="overskrift"><br>
            <select id="kategorier" onchange="kategoriValg()"></select>
            <label for="description">Innhold</label> 
            <textarea name="textarea" id="postinnhold" style="width:250px;height:150px;"></textarea>
            <br>
            <button type="button" id="submitPost">Submit</button>
        </form>
        </div>
    <h1>Lister</h1>
    <div id="lister">           
    </div>
    </template>
    
</div>
</div>
<script>
    const USER_ROLE = 42;
    let authenticatedUser = null;
    var authenticationToken = null;
    const DEBUG = true;
    let listeid;
    
    ////////////////////////////////////////////////////////////
    //Templates
    
    (function(){
       if(!authenticatedUser){
            displayLoginForm();
           // displayCreateUserForm();
        } else{
            displaySubmitRequestForm();
        }
    })();
    
    function addElement(element){
            document.getElementById("content").appendChild(element);
        }
    function clearScreen(){
        //document.getElementById("content").innerHTML = "";
        let container = document.getElementById("content");
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }
    }
    function createElementFromTemplate(templateID){
        let template = document.querySelector(templateID);
        template = document.importNode(template.content, true);
        return template;
    }
    
    /* function fetchQuote() {
            let request = {
                method: "GET",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'x-access-auth': authenticationToken
                }
            }
            fetch("/app/quote", request).then(function (res) {
                if (res.status < 400) {
                    return res.json();
                } else {
                    return Promise.reject(new Error("Session not valid. log inn again"));
                }
            }).then(function (json) {
                document.getElementById("quote").textContent = json.quote;
            }).catch(function (err) {
                displayError(err.message);
            });
        } */ 
    ////////////////////////////////////////////////////////////
    
    function displayLoginForm(){
        let loginForm = createElementFromTemplate("#authenticateUserUITemplate")
        //loginForm = window.document.body.appendChild(loginForm); 
        
        addElement(loginForm);
        //window.document.body.appendChild(element);
        
        let loginBt = document.querySelector("#loginBt");
        let createBt = document.querySelector("#createUserBt");
        
        loginBt.onclick = function(evt){
            console.log("login bt clicked")
            evt.preventDefault();
            hideError();
            
            let username = document.getElementById("userName").value;
            let password = document.getElementById("password").value;
            //let email = document.getElementById("email").value;
            
            authenticateUser(username, password);
            
            /*if(username.length > 0 && password.length > 0){
                //time to log in
                fetch(`/app/user/${username}`).then(data =>{
                    if(data.status === 200){
                        return data.json()
                    } else{
                        return new PromiseRejectionEvent();
                    }
                }).then(json =>{
                    //user is loggd in
                    authenticatedUser = JSON.parse(json)
                    clearScreen();
                    displaySubmitRequestForm();
                }).catch(err=>{
                    //deal with error
                })
                
            }else{
                alert("danger danger")
            }*/
        }
        
        createBt.onclick = function(evt){
            clearScreen();
            displayCreateUserForm();
            console.log("Create user bt clicked")
        }
    } //Logge inn
    
    function authenticateUser(username, password) {
            log("Starting authentication request", `Username ${username}`, `Password ${password}`);
            // We are going to base our authentication on basic authentication. This is a authentication scheme suported by http (RFC 7617)
            // Read more about it at https://en.wikipedia.org/wiki/Basic_access_authentication and https://developer.mozilla.org/en-US/docs/Web/HTTP/Authentication#Basic_authentication_scheme
            let credentials = `Basic ${btoa(username + ":" + password)}`; // This creates a string that looks similar to  "Basic KL9zxHppU2VCX". btoa is a function of the window object.
            let request = {
                method: "GET",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'Authorization': credentials
                }
            }
            fetch("/app/authenticate", request).then(function (respons) {
                if (respons.status < 400) {
                    // OK we are authenticated.
                    return respons.json(); // Grab the JSON payload. 
                } else if (respons.status === 401) {
                    // Username or password was wrong, informe the user.
                    return Promise.reject(new Error("Wrong username or password"));
                } else {
                    // Some other thing went wrong.
                    return Promise.reject(new Error("Could not log you in at this time, try again later"));
                }
            }).then(function (responsJSON) {
                authenticationToken = responsJSON.auth; // Because this is where the server puts the token.
                authenticatedUser = responsJSON.user; // Information about the user. 

                displayUserListView();

            }).catch(function (err) {
                // fetch could not complete the request.
                displayError(err.message);
            });
        } //Auth
    
    ////////////////////////////////////////////////////////////
    
    function displayCreateUserForm(){
        let element =  createElementFromTemplate("#createUserUITemplate");
        document.getElementById("content").appendChild(element);
        
            let form = document.getElementById("createUserForm");
            form.onsubmit = function(evt){
                evt.preventDefault();

                let userName = document.getElementById("userName").value;
                let password = document.getElementById("password").value;
                let email = document.getElementById("email").value;
                let role = USER_ROLE;
                
                fetch('/app/user',{
                    method:"POST",
                    body:JSON.stringify({
                        name:userName,
                        pswHash:password,
                        userRole:role,
                        email:email
                    }),
                    headers: {
                        "Content-Type": "application/json; charset=utf-8"
                    },

                }).then(function(data){
                    if(data.status < 400){
                        return data.json();
                    }
                }).then(function(createdUser){
                    if(createdUser){
                        //We have a newly created user!!
                        clearScreen();
                        displayLoginForm();

                    }
                }).catch(err =>{
                console.error(err);
            });
            }
            /*createNewUserBt.onclick = function(evt){
                clearScreen();
                displayLoginForm();
                console.log("createNewUserBt klikk")
            }  */     
    } //Lage Bruker
    
    ////////////////////////////////////////////////////////////

    function displayUserListView(){
        clearScreen();
        let createTaskForm =  createElementFromTemplate("#createTaskTemplate");
        document.getElementById("content").appendChild(createTaskForm);
        submitTask.onclick = function (evt) {
          //evt.preventDefault();

                let tittel = document.getElementById("tittel").value;
                let innhold = document.getElementById("innhold").value;
                let dueDate = "";
                
                fetch('/app/list',{
                    method:"POST",
                    body:JSON.stringify({
                        tittel:tittel,
                        innhold:innhold,
                        user:authenticatedUser,
                        token:authenticationToken
                        
                    }),
                    headers: {
                        "Content-Type": "application/json; charset=utf-8"
                        
                    },

                }).then(function(data){
                    if(data.status < 400){
                        return data.json();
                    }
                }).then(function(listoflists2){
                    displayExistingLists(); //Oppdaterer listen med lister når man lager ny liste
                    console.log(listoflists2);
                }).catch(err =>{
                console.error(err);
            });
        }
        submitPost.onclick = function (evt) {
                //evt.preventDefault();

                let overskrift = document.getElementById("overskrift").value;
                let postinnhold = document.getElementById("postinnhold").value;
                let liste = document.getElementById("kategorier").value;
                let dueDate = "";
                
                fetch('/app/list/posts',{
                    method:"POST",
                    body:JSON.stringify({
                        overskrift:overskrift,
                        postinnhold:postinnhold,
                        user:authenticatedUser,
                        token:authenticationToken,
                        listeid:listeid
                    }),
                    headers: {
                        "Content-Type": "application/json; charset=utf-8"
                        
                    },

                }).then(function(data){
                    if(data.status < 400){
                        return data.json();
                    }
                }).then(function(listoflists2){
                    displayExistingLists(); //Oppdaterer listen med lister når man lager ny liste
                    displayExistingPosts();
                    console.log(listoflists2);
                }).catch(err =>{
                console.error(err);
            });
        }
        addElement(createTaskForm);
        displayExistingLists();
        displayExistingPosts();
    } //Lage lister og poster
    
     ////////////////////////////////////////////////////////////
    
    function displayExistingLists(){
     fetch('/app/lists?token=' + authenticatedUser.id,{
                    method:"GET",
                    headers: {
                        "Content-Type": "application/json; charset=utf-8"
                    },

                }).then(function(data){
                    if(data.status < 400){
                        return data.json();
                    }
                }).then(function(json){
                    
                    console.log(json);
                    showList(json);
                }).catch(err =>{
                    console.error(err);
                });    
    } //Vise Lister fetch
    
    function displayExistingPosts(){
        fetch('/app/posts?token=' + authenticatedUser.id,{
                    method:"GET",
                    headers: {
                        "Content-Type": "application/json; charset=utf-8"
                    },

                }).then(function(data){
                    if(data.status < 400){
                        return data.json();
                    }
                }).then(function(poster){
                    console.log(poster);
                    showPosts(poster);
                }).catch(err =>{
                    console.error(err);
                });
    }
    //Kanskje kjøre queData, postData??
    function showList(queData){
        var liste = document.getElementById("lister")
        liste.innerHTML = "";
        for(i = 0; i < queData.length; i++){
            /*
            if(queData[i].id == postData.listid){
                post += postData.overskrift + postData.innhold
            }*/
            
            console.log(queData[i]);
            liste.innerHTML += 
            `<div id="liste" class="liClass-` + i + `">` + 
            "<h2>" + queData[i].title + "</h2>" +
            "<h4>" + queData[i].description + "</h4>" +
            
            "</div>"
;
        }
        
        //Create and append the options
        for (var i = 0; i < queData.length; i++) {
            var option = document.createElement("option");
            option.value = queData[i].id;
            option.text = queData[i].title;
            kategorier.options.add(option);
        }
        
    } // Vise Lister
    
    
    
/////////////////////////////////////////////////////////////////
    
    function showPosts(postData){
            console.log(postData);
            for (var ix = 0; ix < postData.length; ix++) {
                console.log(postData[ix]);
            }
        }
    
    function kategoriValg(){
        console.log("valg funker");
        let valg = document.getElementById("kategorier").value;
        console.log(valg);
        listeid = valg;
        
        //var listeid = document.getElementsByTagName("option")[valg].value;
       //console.log(listeid);
    }
    
    function displayError(msg) {
            let errView = document.getElementById("errorView");
            errView.removeAttribute("hidden");
            errView.querySelector("#msg").textContent = msg;
        }
    function hideError() {
        let errView = document.getElementById("errorView");
        errView.setAttribute("hidden", true);
    }
    function log(...messages) {
            if (DEBUG) {
                messages.forEach(msg => {
                    console.log(msg);
                })
            }
        }
    
/////////////////////////////////////////////////////////////////
    
    function changeStyle(path){
        document.getElementById("style").setAttribute("href", path);  
    }   //Stylesheet
    
/////////////////////////////////////////////////////////////////
</script>

</body>
</html>
