<!DOCTYPE html>
<html>
<head>
    <link href="https://fonts.googleapis.com/css?family=Lato:900" rel="stylesheet">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link id="basestyle" rel="stylesheet" type="text/css" href="/style/style.css">
    <link id="style" rel="stylesheet" type="text/css" href="/style/style.css">
</head>
<body>
<div id="theme">
<div id="container">
<div id="header">
<h1>ToDo Applikasjonen</h1>
</div>
<div id="content">
</div>
    <template id="addRequestTemplate">
        <form>
            <label for="description">Description:</label>
            <input type="text" id="description">
            <button id="submitRequest" type="button">Submit</button>
        </form>
    </template>

    <template id="authenticateUserUITemplate">
        <form>
            <label for="userName">Username:</label><br/>
            <input type="text" id="userName"><br/>

            <label for="password">Password:</label><br/>
            <input type="password" id="password"><br/>

            <label for="rememberMe">Remember Me:</label>
            <input type="checkbox" id="rememberMe"><br/>

            <button type="button" id="loginBt">Login</button>
            <button type="button" id="createUserBt">Create User</button>
        </form>
        <div id="errorView" class="card error" hidden>
            <div class="section">
                <h1>Error</h1>
            </div>
            <div class="section">
                <p id="msg"></p>
            </div>
        </div>
    </template>

    <template id="createUserUITemplate">
        <form id="createUserForm">
            <label for="userName">Username:</label><br/>
            <input type="text" id="userName"><br/>

            <label for="email">E-mail:</label><br/>
            <input type="email" id="email"><br/>

            <label for="password">Password:</label><br/>
            <input type="password" id="password"><br/>

            <button>Create</button>
        </form>

    </template>
    
    <template id="welcomeView">
        <div class="card">
            <div class="section">
                <h1>Welcome</h1>
            </div>
            <div class="section">
                <button id="quotebt">Get Quote</button>
            </div>
            <div class="section">
                <q id="quote"></q>
            </div>
        </div>
        <div id="errorView" class="card error" hidden>
            <div class="section">
                <h1>Error</h1>
            </div>
            <div class="section">
                <p id="msg"></p>
            </div>
        </div>
    </template>
    
</div>
<div id="footer">
    <button id="defaultStyle" type="button" name ="defaultTheme" onclick="changeStyle('style/style.css')">Default</button>
    <button id="stylesheet1" type="button" name="darkTheme" onclick="changeStyle('style/theme1.css')">Dark</button>
    <button id="stylesheet2" type="button" name="colorTheme" onclick="changeStyle('style/theme2.css')">Color</button>
</div>
</div>
<script>
    const USER_ROLE = 42;
    let authenticatedUser = null;
    var authenticationToken = null;
    const DEBUG = true;
    
    (function(){
       if(!authenticatedUser){
            displayLoginForm();
           // displayCreateUserForm();
        } else{
            displaySubmitRequestForm();
        }
    })();
    
    function addElement(element){
            document.getElementById("content").appendChild(element);
        }
    function clearScreen(){
        document.getElementById("content").innerHTML = "";
    }
    
    function createElementFromTemplate(templateID){
        let template = document.querySelector(templateID);
        let clone = document.importNode(template.content, true);
        return clone;
    }
    
    function authenticateUser(username, password) {
            log("Starting authentication request", `Username ${username}`, `Password ${password}`);
            // We are going to base our authentication on basic authentication. This is a authentication scheme suported by http (RFC 7617)
            // Read more about it at https://en.wikipedia.org/wiki/Basic_access_authentication and https://developer.mozilla.org/en-US/docs/Web/HTTP/Authentication#Basic_authentication_scheme
            let credentials = `Basic ${ btoa(username + ":" + password)}`; // This creates a string that looks similar to  "Basic KL9zxHppU2VCX". btoa is a function of the window object.
            let request = {
                method: "GET",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'Authorization': credentials
                }
            }
            fetch("/app/authenticate", request).then(function (respons) {
                if (respons.status < 400) {
                    // OK we are authenticated.
                    return respons.json(); // Grab the JSON payload. 
                } else if (respons.status === 401) {
                    // Username or password was wrong, informe the user.
                    return Promise.reject(new Error("Wrong username or password"));
                } else {
                    // Some other thing went wrong.
                    return Promise.reject(new Error("Could not log you in at this time, try again later"));
                }
            }).then(function (responsJSON) {
                authenticationToken = responsJSON.auth; // Because this is where the server puts the token.
                authenticatedUser = responsJSON.user; // Information about the user. 
                displayWelcome();
            }).catch(function (err) {
                // fetch could not complete the request.
                displayError(err.message);
            });
        }
    
     function fetchQuote() {
            let request = {
                method: "GET",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'x-access-auth': authenticationToken
                }
            }
            fetch("/app/quote", request).then(function (res) {
                if (res.status < 400) {
                    return res.json();
                } else {
                    return Promise.reject(new Error("Session not valid. log inn again"));
                }
            }).then(function (json) {
                document.getElementById("quote").textContent = json.quote;
            }).catch(function (err) {
                displayError(err.message);
            });
        }
    
    /////////////////////////////////////////////////////////////////////////////////////////////////////
    
    function displayLoginForm(){
        let loginForm = createElementFromTemplate("#authenticateUserUITemplate")
        //loginForm = window.document.body.appendChild(loginForm); 
        
        addElement(loginForm);
        //window.document.body.appendChild(element);
        
        let loginBt = document.querySelector("#loginBt");
        let createBt = document.querySelector("#createUserBt");
        
        loginBt.onclick = function(evt){
            console.log("login bt clicked")
            evt.preventDefault();
            hideError();
            
            let username = document.getElementById("userName").value;
            let password = document.getElementById("password").value;
            //let email = document.getElementById("email").value;
            
            authenticateUser(username, password);
            
            /*if(username.length > 0 && password.length > 0){
                //time to log in
                fetch(`/app/user/${username}`).then(data =>{
                    if(data.status === 200){
                        return data.json()
                    } else{
                        return new PromiseRejectionEvent();
                    }
                }).then(json =>{
                    //user is loggd in
                    authenticatedUser = JSON.parse(json)
                    clearScreen();
                    displaySubmitRequestForm();
                }).catch(err=>{
                    //deal with error
                })
                
            }else{
                alert("danger danger")
            }*/
        }
        
        createBt.onclick = function(evt){
            clearScreen();
            displayCreateUserForm();
            console.log("Create user bt clicked")
        }
    }
    
    /////////////////////////////////////////////////////////////////////////////////////////////////////
    
    function displayCreateUserForm(){
        let element =  createElementFromTemplate("#createUserUITemplate");
        document.getElementById("content").appendChild(element);
        
            let form = document.getElementById("createUserForm");
            form.onsubmit = function(evt){
                evt.preventDefault();

                let userName = document.getElementById("userName").value;
                let password = document.getElementById("password").value;
                let email = document.getElementById("email").value;
                let role = USER_ROLE;

                fetch('/app/user',{
                    method:"POST",
                    body:JSON.stringify({
                        name:userName,
                        pswHash:password,
                        userRole:role,
                        email:email
                    }),
                    headers: {
                        "Content-Type": "application/json; charset=utf-8"
                    },

                }).then(function(data){
                    if(data.status < 400){
                        return data.json();
                    }
                }).then(function(createdUser){
                    if(createdUser.id){
                        //We have a newly created user!!
                        clearScreen();
                        displayLoginForm();

                    }
                }).catch(err =>{
                console.error(err);
            });
            }
    }
    
    /////////////////////////////////////////////////////////////////////////////////////////////////////
    
    function displaySubmitRequestForm(){
        
    }
    
     function displayWelcome() {
            clearContainer();
            let welcome = getTemplate("welcomeView");
            let bt = welcome.querySelector("#quotebt");
            bt.onclick = function (evt) {
                fetchQuote();
            }
            document.body.appendChild(welcome);
        }
    
    function displayError(msg) {
            let errView = document.getElementById("errorView");
            errView.removeAttribute("hidden");
            errView.querySelector("#msg").textContent = msg;
        }
        function hideError() {
            let errView = document.getElementById("errorView");
            errView.setAttribute("hidden", true);
        }
    function clearContainer() {
            let container = document.getElementById("container");
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }
        }
    
    function log(...messages) {
            if (DEBUG) {
                messages.forEach(msg => {
                    console.log(msg);
                })
            }
        }
        function changeStyle(path){
            document.getElementById("style").setAttribute("href", path);
            
        }
    
</script>

</body>
</html>
