<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
</head>
<body>
<h1>ToDo App</h1>

<div id="content">

    </div>
    <template id="addRequestTemplate">
        <form>
            <label for="description">Description:</label>
            <input type="text" id="description">
            <button id="submitRequest" type="button">Submit</button>
        </form>
    </template>

    <template id="authenticateUserUITemplate">
        <form>
            <label for="userName">User name:</label>
            <input type="text" id="userName">

            <label for="password">Password:</label>
            <input type="password" id="password">

            <label for="rememberMe">Remember Me:</label>
            <input type="checkbox" id="rememberMe">

            <button type="button" id="loginBt">Login</button>
            <button type="button" id="createUserBt">Create User</button>
        </form>
    </template>

    <template id="createUserUITemplate">
        <form>
            <label for="userName">User name:</label>
            <input type="text" id="userName">

            <label for="email">E-mail:</label>
            <input type="email" id="email">

            <label for="password">Password:</label>
            <input type="password" id="password">

            <button>Create</button>
        </form>

    </template>

<script>
    const USER_ROLE = 42;
    let authenticatedUser = null;
    
    (function(){
       if(!authenticatedUser){
            displayLoginForm();
           // displayCreateUserForm();
        } else{
            displaySubmitRequestForm();
        }
    })();
    
    function addElement(element){
            document.getElementById("content").appendChild(element);
        }
    function clearScreen(){
        document.getElementById("content").innerHTML = "";
    }
    
    function createElementFromTemplate(templateID){
        let template = document.querySelector(templateID);
        let clone = document.importNode(template.content, true);
        return clone;
    }
    
    /////////////////////////////////////////////////////////////////////////////////////////////////////
    
    function displayLoginForm(){
        let loginForm = createElementFromTemplate("#authenticateUserUITemplate")
        //loginForm = window.document.body.appendChild(loginForm); 
        
        addElement(loginForm);
        //window.document.body.appendChild(element);
        
        let loginBt = document.querySelector("#loginBt");
        let createBt = document.querySelector("#createUserBt");
        
        loginBt.onclick = function(evt){
            console.log("login bt clicked")
            
            let username = document.getElementById("userName").value;
            let password = document.getElementById("password").value;
            let email = document.getElementById("email").value;
            
            
            
            if(username.length > 0 && password.length > 0){
                //time to log in
                fetch(`app/user/${username}`).then(data =>{
                    if(data.status === 200){
                        return data.json()
                    } else{
                        return new PromiseRejectionEvent();
                    }
                }).then(json =>{
                    //user is loggd in
                    authenticatedUser = JSON.parse(json)
                    clearScreen();
                    displaySubmitRequestForm();
                }).catch(err=>{
                    //deal with error
                })
                
            }else{
                alert("danger danger")
            }
        }
        
        /*
    let form = document.getElementById("createUserForm");
    form.onsubmit = function(evt){
        evt.preventDefault();
        
        let userName = document.getElementById("userName").value;
        let password = document.getElementById("password").value;
        let email = document.getElementById("email").value;
        let role = USER_ROLE;
        
        fetch('app/user',{
            method:"POST",
            body:{
                name:userName,
                pswHash:password,
                userRole:role,
                email:email
            },
            headers: {
                "Content-Type": "application/json; charset=utf-8"
            },
            
        }).then(function(data){
            if(data.status < 400){
                return data.json();
            }
        }).then(function(createdUser){
            if(createdUser.id){
                //We have a newly created user!!
                clearScreen();
                displayLoginForm();
                
            }
        });
    }
        */
        
        createBt.onclick = function(evt){
            clearScreen();
            displayCreateUserForm();
            console.log("Create user bt clicked")
        }
    }
    
    /////////////////////////////////////////////////////////////////////////////////////////////////////
    
    function displayCreateUserForm(){
        let element =  createElementFromTemplate("#createUserUITemplate");
        window.document.body.appendChild(element);
        
            let form = document.getElementById("createUserForm");
            form.onsubmit = function(evt){
                evt.preventDefault();

                let userName = document.getElementById("userName").value;
                let password = document.getElementById("password").value;
                let email = document.getElementById("email").value;
                let role = USER_ROLE;

                fetch('/app/user',{
                    method:"POST",
                    body:{
                        name:userName,
                        pswHash:password,
                        userRole:role,
                        email:email
                    },
                    headers: {
                        "Content-Type": "application/json; charset=utf-8"
                    },

                }).then(function(data){
                    if(data.status < 400){
                        return data.json();
                    }
                }).then(function(createdUser){
                    if(createdUser.id){
                        //We have a newly created user!!
                        clearScreen();
                        displayLoginForm();

                    }
                });
            }
    }
    
    /////////////////////////////////////////////////////////////////////////////////////////////////////
    
    function displaySubmitRequestForm(){
        
    }
    
</script>

</body>
</html>
